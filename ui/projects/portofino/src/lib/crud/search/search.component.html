<div fxLayout="column" fxLayoutGap="20px">
  <div *ngIf="searchProperties.length">
    <span>{{ 'Search' | translate }}</span>
    <form (submit)="search()" [formGroup]="form">
      <div fxLayout="row wrap" fxLayoutGap="10px" fxLayoutAlign="default center">
        <portofino-crud-search-field *ngFor="let field of searchProperties" [form]="form" [property]="field">
        </portofino-crud-search-field>
      </div>
      <div fxLayout="row">
        <button mat-raised-button color="primary" (click)="search()">
          <mat-icon>search</mat-icon>
          {{ 'Search' | translate }}
        </button>
        <button mat-raised-button (click)="clearSearch()" type="reset">{{ 'Clear' | translate }}</button>
      </div>
    </form>
  </div>
  <div class="search-results" fxLayout="column" fxLayoutGap="20px" fxLayoutAlign="start stretch">
    <table mat-table [dataSource]="resultsDataSource" *ngIf="isDataTable()"
           matSort (matSortChange)="sort($event)"
           class="mat-elevation-z8">
      <ng-container [matColumnDef]="selectColumnName" *ngIf="selectionEnabled">
        <th mat-header-cell *matHeaderCellDef>
          <mat-checkbox (change)="$event ? toggleSelectAll() : null"
                        [checked]="selection.hasValue() && isAllSelected()"
                        [indeterminate]="selection.hasValue() && !isAllSelected()">
          </mat-checkbox>
        </th>
        <td mat-cell *matCellDef="let row">
          <mat-checkbox (click)="$event.stopPropagation()"
                        (change)="$event ? selection.toggle(row) : null"
                        [checked]="selection.isSelected(row)">
          </mat-checkbox>
        </td>
      </ng-container>
      <ng-container *ngFor="let property of resultProperties" [matColumnDef]="property.name">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>{{property.label}}</th>
        <td mat-cell *matCellDef="let row">
          <a [routerLink]="baseUrl + '/' + row.__rowKey" *ngIf="property.key">
            {{row[property.name].displayValue || row[property.name].value}}
          </a>
          <span *ngIf="!property.key">
            <a *ngIf="property.kind == 'blob'" [href]="getBlobUrl(row.__rowKey, property)">
              {{row[property.name].displayValue}}
            </a>
            <ng-container *ngIf="property.kind != 'blob'">
              {{row[property.name].displayValue || row[property.name].value}}
            </ng-container>
          </span>
        </td>
      </ng-container>
      <tr mat-header-row *matHeaderRowDef="columnsToDisplay; sticky: true"></tr>
      <tr mat-row *matRowDef="let row; columns: columnsToDisplay"></tr>
    </table>
    <cdk-virtual-scroll-viewport *ngIf="!isDataTable()" (scrolledIndexChange)="test($event)"
                                 itemSize="50" style="height: 200px;"> <!--TODO autosize? -->
      <div *cdkVirtualFor="let row of resultsDataSource" style="height: 50px; border-bottom: dashed grey 1px;"> <!-- TODO External CSS -->
        <ng-container *ngFor="let property of resultProperties; let i = index;">
          <span *ngIf="property.key">
            {{property.label}}
            <a [routerLink]="baseUrl + '/' + row.__rowKey">
              {{row[property.name].displayValue || row[property.name].value}}
            </a>
          </span>
          <span *ngIf="!property.key && i < 3">
            {{property.label}}
            <a *ngIf="property.kind == 'blob'" [href]="getBlobUrl(row.__rowKey, property)">
              {{row[property.name].displayValue}}
            </a>
            <ng-container *ngIf="property.kind != 'blob'">
              {{row[property.name].displayValue || row[property.name].value}}
            </ng-container>
          </span>
        </ng-container>
      </div>
    </cdk-virtual-scroll-viewport>
    <div fxLayout="row" fxLayoutAlign="space-between center">
      <div fxLayout="row" fxLayout.xs="column">
        <ng-template [ngTemplateOutlet]="buttons"></ng-template>
      </div>
      <mat-paginator *ngIf="isDataTable()"
                     [length]="results ? results.totalRecords : 0" [pageSize]="pageSize" (page)="loadPage($event)">
      </mat-paginator>
    </div>
  </div>
</div>
